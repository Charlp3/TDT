<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>TTL4 üèì v6.2</title>
<meta content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" name="viewport"/>
<style>
/* === MONTANT : chiffres plus grands et en gras === */
td input[type="number"]{
  font-size:1.15rem;   /* plus grand */
  font-weight:700;     /* en gras */
  text-align:right;    /* plus lisible */
}
/* === NOMS & PR√âNOMS EN GRAS === */
tbody td:first-child{
  font-weight:700;
}
:root{
  --bg-dark:#d1d3d8;
  --bg-mid:#e1e3e8;
  --bg-light:#f2f3f6;

  --panel:#ffffff;
  --ink:#111;
  --sub:#555;
  --border:#b8bbc2;

  --ok:#28cd41;
  --warn:#ffcc00;
  --bad:#ff3b30;

  --blueLight:#b5e3ff;
  --head:#2b2f3a;
  --head-ink:#f2f2f7;
}

/* RESET */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

/* === LAYOUT ROOT (CORRECTION CLEF) === */
body{
  margin:0;
  min-height:100svh;
  display:flex;
  flex-direction:column;
  color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,Helvetica,Arial,sans-serif;
  background:linear-gradient(180deg,var(--bg-dark)0,var(--bg-mid)280px,var(--bg-light)100%);
}

/* HEADER */
header{
  position:sticky;
  top:0;
  z-index:10;
  background:#c5c8cf;
  border-bottom:1px solid var(--border);
  padding:calc(6px + env(safe-area-inset-top)) 12px 6px;
}
h1{
  margin:0;
  display:flex;
  align-items:center;
  gap:8px;
  font-size:1rem;
  font-weight:800;
}
.version,.copyright{
  font-size:.85rem;
  color:#333;
}
.spacer{flex:1}
.counters{
  display:flex;
  gap:8px;
  align-items:center;
}
.counter{
  width:34px;
  height:34px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:.75rem;
  border:2px solid transparent;
}
.counter.presence{
  font-size:.72rem;
  letter-spacing:-0.5px;
}
.counter.green{background:#c9f2cf;border-color:var(--ok)}
.counter.yellow{background:#fff2c4;border-color:var(--warn)}
.counter.presence{background:#cfe9ff;color:#003b66;border-color:#6dbafc}

/* WRAP prend TOUT l‚Äôespace sous le header */
.wrap{
  flex:1;
  display:flex;
  flex-direction:column;
  max-width:1100px;
  margin:0 auto;
  padding:12px;
}

/* CARD = colonne flex pleine hauteur */
.card{
  flex:1;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

/* TOOLBAR */
.toolbar{
  display:flex;
  gap:6px;
  padding:8px;
  align-items:center;
  flex-wrap:wrap;
  background:#dadce2;
  border-bottom:1px solid var(--border);
}
.btn{
  height:28px;
  min-width:34px;
  border-radius:8px;
  border:1px solid #aeb2bb;
  background:#f4f5f7;
  font-size:1rem;
  cursor:pointer;
}
.btn.blueLight{
  background:rgba(0,122,255,0.18);
  color:#004080;
  border:1px solid rgba(0,122,255,0.25);
}
.btn.locked{background:#f5c5c5;color:#900}
.btn.unlocked{background:#c8f0d2;color:#060}
.stat{
  background:#fff;
  border:1px solid var(--border);
  padding:4px 10px;
  border-radius:999px;
  font-weight:700;
  color:#444;
}

/* ADD FORM */
form.add{
  display:grid;
  grid-template-columns:repeat(4,1fr) auto;
  gap:8px;
  padding:8px;
  background:#e2e4e9;
  border-bottom:1px solid var(--border);
}
label{font-size:.78rem;color:#444}
input{
  width:100%;
  height:36px;
  padding:6px 8px;
  border-radius:8px;
  border:1px solid #b5b8c0;
}

/* TABLE ZONE = FLEX:1 (CORRECTION CLEF) */
.tbl-wrap{
  flex:1;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}

/* TABLE */
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
}
thead th{
  position:sticky;
  top:0;
  background:var(--head);
  color:var(--head-ink);
  padding:6px 8px;
  font-size:.75rem;
}
tbody td{
  padding:6px 8px;
  border-bottom:1px solid #d0d2d8;
  font-size:.9rem;
}

/* ZEBRA */
tbody tr:nth-child(odd){background:#f1f2f5}
tbody tr:nth-child(even){background:#e6e8ed}

/* largeur colonne Pay√© (1 ‚Ç¨) */
.col-paid{
  width: 90px;
  min-width: 90px;
  text-align: center;
}

/* PRIORIT√â √âTAT */
tr.row-green{background:#e0f6e3 !important}
tr.row-yellow{background:#fff5d6 !important}

.hiddenCol{display:none}
/* SCROLL TABLE SOUS LE TITRE */
.table-wrap{
  max-height: calc(100vh - 260px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* En-t√™te du tableau fixe */
thead th{
  position: sticky;
  top: 0;
  z-index: 5;
  background: var(--head);
}
/* OPTIONS */
.sheet{
  position:fixed;
  left:0;right:0;bottom:0;
  background:#f4f5f7;
  border-radius:12px 12px 0 0;
  box-shadow:0 -6px 20px rgba(0,0,0,.3);
  transform:translateY(100%);
  transition:.25s;
  padding:12px;
}
.sheet.show{transform:translateY(0)}
.sheet .row{
  display:flex;
  justify-content:space-between;
  padding:12px 0;
  border-bottom:1px solid #ccc;
}
.sheet .actions{text-align:right;padding-top:10px}

/* TOAST */
.toast{
  position:fixed;
  bottom:16px;
  right:16px;
  background:#222;
  color:#fff;
  padding:8px 12px;
  border-radius:8px;
  opacity:0;
  transition:.25s;
  font-size:.8rem;
}
.toast.show{opacity:1}


html, body{height:100%;}
body{overflow:hidden;}
.wrap,.card,.tbl-wrap{min-height:0;}
.tbl-wrap{-webkit-overflow-scrolling:touch;}

</style>
</head>
<body>
<header>
<h1>
<span>TTL4 üèì <span class="version" id="version">v6.3</span></span>
<span class="copyright">¬© Pierre Charlier 2025</span>
<span class="spacer"></span>
<div class="counters">
<div class="counter presence" id="countPresence">0%</div>
<div class="counter green" id="countGreen">0</div>
<div class="counter yellow" id="countYellow">0</div>
</div>
</h1>
</header>
<div class="wrap">
<div class="card">
<div class="toolbar">
<button class="btn" id="btnImportCSV" title="Importer CSV">üì•</button>
<button class="btn" id="btnOptions">‚öôÔ∏è</button>
<button class="btn" id="btnExportStats" title="Exporter statistiques">üìä</button>
<button class="btn unlocked" id="btnLock">üîì</button>
<button class="btn blueLight" id="btnClearData">üßπ</button>
<span class="stat">Inscrits: <strong id="statInscrits">0</strong></span>
<span class="stat">Pr√©sents: <strong id="statPresents">0</strong></span>
<span class="stat">Total: <strong id="statTotal">0,00 ‚Ç¨</strong></span>
</div>
<form class="add" id="addForm">
<div><label>Pr√©nom</label><input id="prenom"/></div>
<div><label>Nom</label><input id="nom"/></div>
<div><label>Tel</label><input id="tel"/></div>
<div><label>Mail</label><input id="mail"/></div>
<button class="btn">+</button>
</form>
<div class="tbl-wrap">
<table>
<thead>
<tr>
<th id="thName">Nom &amp; Pr√©nom</th>
<th class="th-tel">T√©l√©phone</th>
<th class="th-mail">E-mail</th>
<th>Pr√©sent</th>
<th class="col-paid">Pay√© (1 ‚Ç¨)</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>
</div>
<div class="sheet" id="sheetOptions">
<h3>Options</h3>
<div class="row">
<span>Afficher Tel &amp; Mail</span>
<button class="btn" id="btnToggleCols">üëÅÔ∏è</button>
</div>
<div class="row">
<span>Supprimer toute la liste</span>
<button class="btn blueLight" id="btnDeleteAll">üóë</button>
</div>
<div class="actions">
<button class="btn" id="btnCloseOptions">‚úï</button>
</div>
</div>
<div class="toast" id="toast"></div>
<script>
const STORAGE_KEY='tdtl_state';
const $=s=>document.querySelector(s);
let state=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
if(!state.players)state={players:[],locked:false,showCols:false};

function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}
function toast(m){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1200);}
function rowClass(p){
  if(!p.present) return '';
  if(p.present && p.paid) return 'row-green';
  return 'row-yellow';
}

/* ===== TRI Nom & Pr√©nom (A‚ÜîZ) ===== */
let sortAsc = true;
const thName = document.getElementById('thName');
if(thName){
  thName.style.cursor='pointer';
  thName.addEventListener('click', ()=>{
    sortAsc = !sortAsc;
    state.players.sort((a,b)=>{
      const an=((a.nom||'')+' '+(a.prenom||'')).toLowerCase();
      const bn=((b.nom||'')+' '+(b.prenom||'')).toLowerCase();
      return sortAsc ? an.localeCompare(bn) : bn.localeCompare(an);
    });
    save();
    render();
  });
}

function render(){
  const tb=$('#tbody');tb.textContent='';
  let cnt={g:0,y:0,r:0},total=0;
  state.players.forEach(p=>{
    const tr=document.createElement('tr');
    const rc=rowClass(p);
    if(rc)tr.classList.add(rc);
    if(rc==='row-green')cnt.g++;
    if(rc==='row-yellow')cnt.y++;
    if(p.present && p.paid) total += 1;

    tr.innerHTML=`
      <td>${p.nom} ${p.prenom}</td>
      <td class="td-tel">${p.tel||'‚Äî'}</td>
      <td class="td-mail">${p.mail||'‚Äî'}</td>
      <td style="text-align:center"><input type="checkbox"${p.present?' checked':''}${state.locked?' disabled':''}></td>
<td class="col-paid">
  <input type="checkbox" class="chkPaid"
    ${p.paid ? 'checked' : ''}
    ${state.locked ? 'disabled' : ''}>
</td>
      <td><button class="btn btnEdit" title="√âditer">‚úé</button> <button class="btn blueLight btnDel" title="Supprimer">üóë</button></td>`;
    if(!state.showCols){
      tr.querySelector('.td-tel').classList.add('hiddenCol');
      tr.querySelector('.td-mail').classList.add('hiddenCol');
    }
    tr.querySelector('input[type=checkbox]').onchange=e=>{p.present=e.target.checked;save();render();}
    const chkPaid = tr.querySelector('.chkPaid');
chkPaid.onchange = e=>{
  p.paid = e.target.checked;
  save();
  render();
};

    const editBtn = tr.querySelector('.btnEdit');
    const delBtn  = tr.querySelector('.btnDel');

    editBtn.onclick=()=>{
      if(state.locked){toast('üîí');return;}
      const nom=prompt('Nom ?',p.nom||''); if(nom===null) return;
      const prenom=prompt('Pr√©nom ?',p.prenom||''); if(prenom===null) return;
      const tel=prompt('Tel ?',p.tel||''); if(tel===null) return;
      const mail=prompt('Mail ?',p.mail||''); if(mail===null) return;
      p.nom=nom.trim(); p.prenom=prenom.trim(); p.tel=tel.trim(); p.mail=mail.trim();
      save(); render();
    };

    delBtn.onclick=()=>{
      if(state.locked){toast('üîí');return;}
      if(confirm('Supprimer ?')){state.players=state.players.filter(x=>x!==p); save(); render();}
    };

    tb.appendChild(tr);
  });

  $('#statInscrits').textContent=state.players.length;
  const pres=state.players.filter(p=>p.present).length;
  $('#statPresents').textContent=pres;
  $('#statTotal').textContent=total.toFixed(2)+' ‚Ç¨';

  $('#countGreen').textContent=cnt.g;
  $('#countYellow').textContent=cnt.y;
  $('#countPresence').textContent=state.players.length?Math.round(pres/state.players.length*100)+'%':'0%';

  document.querySelectorAll('.th-tel,.th-mail').forEach(th=>th.classList.toggle('hiddenCol',!state.showCols));
// üîí Synchronisation visuelle du bouton cadenas au rendu
const lockBtn = $('#btnLock');
lockBtn.className = 'btn ' + (state.locked ? 'locked' : 'unlocked');
lockBtn.textContent = state.locked ? 'üîí' : 'üîì';}

$('#addForm').onsubmit=e=>{
  e.preventDefault();
  state.players.push({
    prenom:$('#prenom').value,
    nom:$('#nom').value,
    tel:$('#tel').value,
    mail:$('#mail').value,
    present:false,
paid:false,
montant:null
  });
  e.target.reset();save();render();
};

$('#btnLock').onclick=()=>{state.locked=!state.locked;$('#btnLock').className='btn '+(state.locked?'locked':'unlocked');save();render();}
$('#btnClearData').onclick=()=>{if(confirm('Effacer pr√©sence et montants ?')){state.players.forEach(p=>{
    p.present = false;
    p.paid = false;
    p.montant = null;
});
save();render();}}
$('#btnOptions').onclick=()=>$('#sheetOptions').classList.add('show');
$('#btnCloseOptions').onclick=()=>$('#sheetOptions').classList.remove('show');
$('#btnToggleCols').onclick=()=>{state.showCols=!state.showCols;save();render();}
$('#btnDeleteAll').onclick=()=>{if(confirm('Supprimer toute la liste ?')){state.players=[];save();render();}}

render();
/* ===== EXPORT STATISTIQUES (pr√©sents + montants) ===== */
(function(){
  const btn = document.getElementById('btnExportStats');
  if (!btn) return;

  btn.onclick = () => {
    if (!state.players || !state.players.length) {
      toast('Aucune donn√©e');
      return;
    }

    const presents = state.players.filter(p => p.present);
    const totalInscrits = state.players.length;
    const totalPresents = presents.length;

    let totalMontant = 0;

    const sep = ';';
    let csv = '\uFEFF';

    // En-t√™te r√©sum√©
    csv += 'Statistiques\n';
    csv += `Inscrits${sep}${totalInscrits}\n`;
    csv += `Pr√©sents${sep}${totalPresents}\n\n`;

    // D√©tail des pr√©sents
    csv += ['Nom', 'Pr√©nom', 'Montant (‚Ç¨)'].join(sep) + '\n';

    presents.forEach(p => {
      const m = p.paid ? 1 : 0;
totalMontant += m;

      csv += [
        `"${(p.nom || '').replace(/"/g,'""')}"`,
        `"${(p.prenom || '').replace(/"/g,'""')}"`,
        m.toFixed(2)
      ].join(sep) + '\n';
    });

    csv += `\nTotal encaiss√©${sep}${totalMontant.toFixed(2)} ‚Ç¨\n`;

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    // Safari iOS / GitHub Pages : ouverture directe
    window.open(url, '_blank');

    setTimeout(() => URL.revokeObjectURL(url), 5000);
    toast('Statistiques export√©es');
  };
})();
/* ===== IMPORT CSV (Nom;Pr√©nom;Tel;Mail) ===== */
(function(){
  const btn = document.getElementById('btnImportCSV');
  if(!btn) return;

  // input fichier invisible
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv,text/csv';

  btn.onclick = () => {
    if(state.locked){
      toast('üîí Liste verrouill√©e');
      return;
    }
    input.click();
  };

  input.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;

    if(!confirm('Importer le CSV et remplacer la liste actuelle ?')){
      input.value='';
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      const text = reader.result;
      const lines = text.split(/\r?\n/).filter(l=>l.trim());
      if(lines.length < 2){
        toast('CSV invalide');
        return;
      }

      const rows = lines.slice(1); // ignore en-t√™te
      const newPlayers = [];

      rows.forEach(line=>{
        const cols = line.split(';');
        if(cols.length < 2) return;

        const nom    = (cols[0]||'').trim();
        const prenom = (cols[1]||'').trim();
        let tel      = (cols[2]||'').trim();
        const mail   = (cols[3]||'').trim();

        if(tel && !tel.startsWith('0')) tel = '0'+tel;

        if(nom || prenom){
          newPlayers.push({
            nom,
            prenom,
            tel,
            mail,
            present:false,
            montant:null
          });
        }
      });

      state.players = newPlayers;
      save();
      render();
      toast('CSV import√©');
      input.value='';
    };

    reader.readAsText(file,'utf-8');
  };
})();
</script>
</body>
</html>