<!doctype html>
<html lang="fr" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <title>TDT v3.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#0a84ff" />
  <style>
    :root{
      --upper:#c7c8ce; --page:#d1d2d8; --panel:#ffffff;
      --ink:#111; --sub:#444; --border:#b1b2b8; --accent:#007aff;
      --ok:#28cd41; --warn:#ffcc00; --bad:#ff3b30;
      --head-dark:#2a2a2c;
      --zebra1:#e0e1e6; --zebra2:#d4d5db;
      --fab-h:60px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --upper:#1b1b1e; --page:#111113; --panel:#1a1a1d;
        --ink:#e6e6eb; --sub:#a1a1a7; --border:#2c2c2e; --accent:#0a84ff;
        --ok:#30d158; --warn:#ffd60a; --bad:#ff453a;
        --head-dark:#1f1f22;
        --zebra1:#2c2c2e; --zebra2:#3a3a3c;
      }
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0;color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      background:linear-gradient(180deg,var(--upper) 0%, var(--page) 420px, var(--page) 100%);
    }

    /* ===== HEADER ===== */
    header{
      position:sticky;top:0;z-index:40;background:var(--upper);
      border-bottom:1px solid var(--border);
      padding:calc(4px + env(safe-area-inset-top)) 12px 4px
    }
    h1{
      margin:0;font-size:1rem;font-weight:700;
      display:flex;align-items:center;gap:8px;
    }
    .version{font-size:.8rem;color:var(--sub)}
    .copyright{margin-left:6px;font-size:.8rem;color:var(--sub)}
    .spacer{flex:1}
    .counters{display:flex;gap:8px;align-items:center}
    .counter{
      width:28px;height:28px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:.8rem;color:#111;
      border:2px solid transparent;box-shadow:0 1px 2px rgba(0,0,0,.12);
    }
    .counter.green  {background:#d9fadd;border-color:var(--ok);}
    .counter.yellow {background:#fff8d4;border-color:var(--warn);}
    .counter.red    {background:#ffe0e0;border-color:var(--bad);}

    .wrap{max-width:1100px;margin:0 auto;padding:12px 12px calc(var(--fab-h) + 16px)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}

    .toolbar{
      display:flex;gap:6px;padding:8px;align-items:center;flex-wrap:wrap;
      background:var(--upper);border-bottom:1px solid var(--border)
    }

    .btn{
      height:28px;
      width:34px;
      padding:0;
      border-radius:8px;
      border:1px solid var(--border);
      background:#fff;
      font-size:1rem;
      cursor:pointer;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .btn.primary{background:linear-gradient(180deg,#0a84ff,#007aff);color:#fff;border:none}
    .btn.danger{background:#ff3b30;color:#fff;border:none}
    .btn.locked{background:#d1d1d6;color:#666;border:none}

    .stat{display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--border);padding:4px 10px;border-radius:999px;font-weight:600}

    form.add{display:grid;grid-template-columns:repeat(4,1fr) auto;gap:8px;padding:8px;background:var(--upper);border-bottom:1px solid var(--border)}
    label{font-size:.78rem;color:var(--sub);margin:0 0 4px}
    input{width:100%;height:38px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:1rem}

    .tblWrap{max-height:60svh;overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:520px}
    thead th{
      position:sticky;top:0;z-index:5;background:var(--head-dark);color:#f2f2f7;
      padding:6px 8px;font-size:.75rem;text-align:left
    }
    tbody td{padding:6px 8px;border-bottom:1px solid var(--border);font-size:.9rem}
    tbody tr:nth-child(odd){background:var(--zebra1)}
    tbody tr:nth-child(even){background:var(--zebra2)}

    .fabBar{position:fixed;left:0;right:0;bottom:0;z-index:50;background:rgba(245,245,247,.96);
      backdrop-filter:blur(8px);border-top:1px solid var(--border);
      padding:8px;display:flex;gap:8px}
    .fabBar .btn{flex:1}

    .toast{position:fixed;bottom:calc(var(--fab-h) + 12px);right:16px;background:#111;color:#fff;
      padding:8px 12px;border-radius:8px;opacity:0;transition:.25s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <h1>
      <span>TDT <span class="version" id="version">v3.2</span></span>
      <span class="copyright">¬© Pierre Charlier 2025</span>
      <span class="spacer"></span>
      <div class="counters">
        <div class="counter green"  id="countGreen">0</div>
        <div class="counter yellow" id="countYellow">0</div>
        <div class="counter red"    id="countRed">0</div>
      </div>
    </h1>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="toolbar">
        <button class="btn" id="btnImport" title="Importer">üì•</button>
        <button class="btn" id="btnOptions" title="Options">‚öôÔ∏è</button>
        <button class="btn" id="btnLock" title="Verrouiller">üîí</button>
        <button class="btn danger" id="btnClearData" title="Effacer donn√©es">üßπ</button>
        <span class="stat">Inscrits: <strong id="statInscrits">0</strong></span>
        <span class="stat">Pr√©sents: <strong id="statPresents">0</strong></span>
        <span class="stat">Total: <strong id="statTotal">0,00 ‚Ç¨</strong></span>
      </div>

      <form class="add" id="addForm" novalidate>
        <div><label>Pr√©nom</label><input id="prenom" required placeholder="Jean"></div>
        <div><label>Nom</label><input id="nom" required placeholder="Dupont"></div>
        <div><label>Tel</label><input id="tel" maxlength="10" inputmode="numeric" placeholder="0412345678"></div>
        <div><label>Mail</label><input id="mail" type="email" placeholder="ex: joueur@mail.fr"></div>
        <button class="btn primary" type="submit">+</button>
      </form>

      <div class="tblWrap">
        <table>
          <thead>
            <tr>
              <th>Nom & Pr√©nom</th>
              <th>T√©l√©phone</th>
              <th>E-mail</th>
              <th>Pr√©sent</th>
              <th>Montant (‚Ç¨)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="empty" style="display:none;padding:12px;text-align:center;color:var(--sub)">Aucun joueur.</div>
    </div>
  </div>

  <div class="fabBar">
    <button class="btn" id="exportNamesAmounts" title="Exporter">üì§</button>
    <button class="btn primary" id="saveAll" title="Sauver">üíæ</button>
  </div>

  <div id="toast" class="toast">‚úîÔ∏è</div>
  <script>
const VERSION='3.2';
document.getElementById('version').textContent='v'+VERSION;

/* Cl√© stable + migration */
const STORAGE_KEY='tdtl_state';
(function migrate(){
  if(localStorage.getItem(STORAGE_KEY)) return;
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(/^tdtl_v_\d+_\d+$/.test(k)){ localStorage.setItem(STORAGE_KEY, localStorage.getItem(k)); break; }
  }
})();

/* Helpers */
const $=s=>document.querySelector(s);
const fmt=n=>(Number(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2});
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function toast(m){ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }

/* √âtat */
let state; try{ state=JSON.parse(localStorage.getItem(STORAGE_KEY))||{} }catch{ state={}; }
if(!state.players) state={ players:[], locked:false };

/* Couleurs */
function badgeClass(p){
  if(!p.present) return '';
  if(p.montant==null || p.montant==='') return 'yellow';
  const m=Number(p.montant);
  if(isNaN(m)) return 'yellow';
  if(m===0) return 'red';
  return 'green';
}

/* Rendu */
function render(){
  const tb=$('#tbody'); tb.textContent='';
  $('#empty').style.display = state.players.length ? 'none' : 'block';
  let cnt={green:0,yellow:0,red:0};

  state.players.forEach(p=>{
    const tr=document.createElement('tr');
    const bc=badgeClass(p);
    if(bc==='green') cnt.green++; else if(bc==='yellow') cnt.yellow++; else if(bc==='red') cnt.red++;

    tr.innerHTML=`
      <td>${(p.nom||'').toUpperCase()} ${(p.prenom||'')}</td>
      <td>${p.tel||'‚Äî'}</td>
      <td>${p.mail||'‚Äî'}</td>
      <td style="text-align:center"><input type="checkbox"${p.present?' checked':''}${state.locked?' disabled':''}></td>
      <td><input type="number" value="${p.montant??''}" style="width:80px"${state.locked?' disabled':''}></td>
      <td><button class="btn"${state.locked?' disabled':''}>‚úé</button> <button class="btn danger"${state.locked?' disabled':''}>üóë</button></td>`;
    const cb=tr.querySelector('input[type=checkbox]');
    const money=tr.querySelector('input[type=number]');
    const [edit,del]=tr.querySelectorAll('button');
    cb.onchange=()=>{p.present=cb.checked;save();render();};
    money.oninput=()=>{p.montant=money.value===''?null:Number(money.value);save();render();};
    edit.onclick=()=>{if(state.locked)return;const n=prompt('Nom ?',p.nom||'');if(!n)return;const pr=prompt('Pr√©nom ?',p.prenom||'');if(!pr)return;p.nom=n;p.prenom=pr;save();render();};
    del.onclick=()=>{if(state.locked)return;if(confirm('Supprimer ?')){state.players=state.players.filter(x=>x!==p);save();render();}};
    tb.appendChild(tr);
  });

  $('#statInscrits').textContent=state.players.length;
  $('#statPresents').textContent=state.players.filter(p=>p.present).length;
  $('#statTotal').textContent=fmt(state.players.reduce((s,p)=>s+(p.present&&Number(p.montant)>0?Number(p.montant):0),0))+' ‚Ç¨';
  $('#countGreen').textContent=cnt.green;
  $('#countYellow').textContent=cnt.yellow;
  $('#countRed').textContent=cnt.red;
}

/* Ajout */
$('#addForm').onsubmit=e=>{
  e.preventDefault();
  if(state.locked){toast('üîí Liste verrouill√©e');return;}
  const prenom=$('#prenom').value.trim(),nom=$('#nom').value.trim();
  if(!prenom||!nom){alert('Nom et pr√©nom requis');return;}
  state.players.push({prenom,nom,tel:$('#tel').value.trim(),mail:$('#mail').value.trim(),present:false,montant:null});
  save();render();e.target.reset();toast('Ajout√© ‚úîÔ∏è');
};

/* Sauvegarde */
$('#saveAll').onclick=()=>{save();toast('Sauvegard√© ‚úîÔ∏è');};

/* Effacer donn√©es */
$('#btnClearData').onclick=()=>{
  if(state.locked){toast('üîí Liste verrouill√©e');return;}
  if(!confirm('Effacer toutes les cases Pr√©sent et montants ?'))return;
  state.players.forEach(p=>{p.present=false;p.montant=null;});
  save();render();toast('Donn√©es effac√©es ‚úîÔ∏è');
};

/* Verrouillage */
$('#btnLock').onclick=()=>{
  state.locked=!state.locked;
  save();
  $('#btnLock').textContent=state.locked?'üîì':'üîí';
  $('#btnLock').className=state.locked?'btn locked':'btn';
  render();
};
$('#btnLock').textContent=state.locked?'üîì':'üîí';
$('#btnLock').className=state.locked?'btn locked':'btn';

/* Export */
$('#exportNamesAmounts').onclick=()=>{
  if(!state.players.length){alert('Rien √† exporter');return;}
  const headers=['Nom complet','Montant'];
  const rows=state.players.map(p=>[
    `${(p.nom||'').trim()} ${(p.prenom||'').trim()}`.trim(),
    (p.montant==null||p.montant==='')?'':String(p.montant)
  ]);
  const csv=[headers.join(';')].concat(rows.map(r=>r.join(';'))).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='noms_montants.csv';
  document.body.appendChild(a);a.click();a.remove();
};

/* Import / Options placeholders */
$('#btnImport')?.addEventListener('click',()=>toast('Import en pr√©paration'));
$('#btnOptions')?.addEventListener('click',()=>toast('Options en pr√©paration'));

render();
</script>
</body>
</html>