<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>TDT v4.0</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<meta name="theme-color" content="#0a84ff" />
<style>
:root{
  --upper:#e9eaee;
  --page:#f4f5f7;
  --panel:#fff;
  --ink:#111;
  --sub:#555;
  --border:#cfd2d7;
  --ok:#28cd41;
  --warn:#ffcc00;
  --bad:#ff3b30;
  --head:#2b2f3a;
  --head-ink:#f2f2f7;
  --blueLight:#b5e3ff;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
  margin:0;
  color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,Helvetica,Arial,sans-serif;
  background:linear-gradient(180deg,var(--upper)0,var(--page)440px,var(--page)100%);
}

/* HEADER */
header{
  position:sticky;
  top:0;
  z-index:10;
  background:var(--upper);
  border-bottom:1px solid var(--border);
  padding:calc(4px + env(safe-area-inset-top)) 12px 6px;
}
h1{
  margin:0;
  display:flex;
  align-items:center;
  gap:8px;
  font-size:1rem;
  font-weight:800;
}
.version,.copyright{
  font-size:.85rem;
  color:var(--sub);
}
.spacer{flex:1}
.counters{
  display:flex;
  gap:8px;
  align-items:center;
}
.counter{
  width:28px;
  height:28px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:.75rem;
  color:#111;
  border:2px solid transparent;
  box-shadow:0 1px 2px rgba(0,0,0,.12);
  line-height:1;
}
.counter.green{background:#d9fadd;border-color:var(--ok)}
.counter.yellow{background:#fff8d4;border-color:var(--warn)}
.counter.red{background:#ffe0e0;border-color:var(--bad)}
/* nouveau % pr√©sents */
.counter.presence{
  background:var(--blueLight);
  color:#004080;
  border-color:#6dbafc;
}

/* LAYOUT */
.wrap{
  max-width:1100px;
  margin:0 auto;
  padding:12px;
}
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
}

/* BARRE DU HAUT */
.toolbar{
  display:flex;
  gap:6px;
  padding:8px;
  align-items:center;
  flex-wrap:wrap;
  background:var(--upper);
  border-bottom:1px solid var(--border);
}
.btn{
  height:28px;
  min-width:34px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fff;
  font-size:1rem;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1;
  transition:background .2s,border .2s,color .2s;
}
.btn.primary{
  background:linear-gradient(180deg,#0a84ff,#007aff);
  color:#fff;
  border:none;
}
/* bleu clair (translucide) */
.btn.blueLight{
  background:rgba(0,122,255,0.15);
  color:#004080;
  border:1px solid rgba(0,122,255,0.2);
}
/* cadenas √©tats */
.btn.locked{
  background:#ffd6d6;
  color:#a00;
  border:1px solid #f99;
}
.btn.unlocked{
  background:#d6ffe0;
  color:#060;
  border:1px solid #8f8;
}

.stat{
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:#fff;
  border:1px solid var(--border);
  padding:4px 10px;
  border-radius:999px;
  font-weight:700;
  color:var(--sub);
}

/* FORM AJOUT */
form.add{
  display:grid;
  grid-template-columns:repeat(4,1fr) auto;
  gap:8px;
  padding:8px;
  background:var(--upper);
  border-bottom:1px solid var(--border);
}
label{
  font-size:.78rem;
  color:var(--sub);
}
input{
  width:100%;
  height:38px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#fff;
  font-size:1rem;
}

/* TABLE */
.tblWrap{
  max-height:60svh;
  overflow:auto;
}
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  min-width:520px;
}
thead th{
  position:sticky;
  top:0;
  z-index:2;
  background:var(--head);
  color:var(--head-ink);
  padding:6px 8px;
  font-size:.75rem;
  text-align:left;
  cursor:pointer;
  user-select:none;
}
tbody td{
  padding:6px 8px;
  border-bottom:1px solid var(--border);
  font-size:.95rem;
}
.hiddenCol{display:none}

/* COULEUR DES LIGNES SELON PR√âSENCE / MONTANT */
tr.row-green {background:#e9fbe9!important}
tr.row-yellow{background:#fff9e6!important}
tr.row-red   {background:#ffecec!important}

/* OPTIONS SHEET */
.sheet{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  z-index:30;
  background:#fff;
  color:#111;
  border-radius:12px 12px 0 0;
  box-shadow:0 -6px 20px rgba(0,0,0,.25);
  transform:translateY(100%);
  transition:.25s;
  padding:12px;
  max-height:70svh;
  overflow:auto;
}
.sheet.show{transform:translateY(0)}
.sheet h3{margin:0 0 10px}
.sheet .row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 0;
  border-bottom:1px solid var(--border);
}
.sheet .actions{
  display:flex;
  gap:10px;
  justify-content:flex-end;
  padding-top:10px;
}

/* TOAST */
.toast{
  position:fixed;
  bottom:16px;
  right:16px;
  background:#111;
  color:#fff;
  padding:8px 12px;
  border-radius:8px;
  opacity:0;
  transition:.25s;
  font-size:.8rem;
  line-height:1.2;
}
.toast.show{opacity:1}
</style>
</head>
<body>
<header>
  <h1>
    <span>TDT <span class="version" id="version">v4.0</span></span>
    <span class="copyright">¬© Pierre Charlier 2025</span>
    <span class="spacer"></span>
    <div class="counters">
      <!-- % pr√©sents -->
      <div class="counter presence" id="countPresence">0%</div>
      <!-- compteurs vert/jaune/rouge -->
      <div class="counter green"  id="countGreen">0</div>
      <div class="counter yellow" id="countYellow">0</div>
      <div class="counter red"    id="countRed">0</div>
    </div>
  </h1>
</header>

<div class="wrap">
  <div class="card">
    <div class="toolbar">
      <button class="btn"           id="btnImport"    title="Importer">üì•</button>
      <button class="btn"           id="btnOptions"   title="Options">‚öôÔ∏è</button>
      <button class="btn unlocked"  id="btnLock"      title="Verrouiller/D√©verrouiller">üîì</button>
      <button class="btn blueLight" id="btnClearData" title="Effacer Pr√©sent+Montants">üßπ</button>

      <span class="stat">Inscrits: <strong id="statInscrits">0</strong></span>
      <span class="stat">Pr√©sents: <strong id="statPresents">0</strong></span>
      <span class="stat">Total: <strong id="statTotal">0,00 ‚Ç¨</strong></span>
    </div>

    <form class="add" id="addForm" novalidate>
      <div><label>Pr√©nom</label><input id="prenom" required></div>
      <div><label>Nom</label><input id="nom" required></div>
      <div><label>Tel</label><input id="tel" maxlength="20"></div>
      <div><label>Mail</label><input id="mail" type="email"></div>
      <button class="btn primary" type="submit">+</button>
    </form>

    <div class="tblWrap">
      <table>
        <thead>
          <tr>
            <th id="thName">Nom & Pr√©nom ‚áÖ</th>
            <th class="th-tel">T√©l√©phone</th>
            <th class="th-mail">E-mail</th>
            <th>Pr√©sent</th>
            <th>Montant (‚Ç¨)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="empty" style="display:none;padding:12px;text-align:center;color:var(--sub)">Aucun joueur.</div>
  </div>
</div>

<!-- Options -->
<div id="sheetOptions" class="sheet" aria-hidden="true">
  <h3>Options</h3>

  <div class="row">
    <span>Afficher Tel & Mail</span>
    <button class="btn" id="btnToggleCols">üëÅÔ∏è</button>
  </div>

  <div class="row">
    <span>Supprimer toute la liste</span>
    <button class="btn blueLight" id="btnDeleteAll">üóë</button>
  </div>

  <div class="actions">
    <button class="btn" id="btnCloseOptions">‚úï</button>
  </div>
</div>

<div id="toast" class="toast">‚úîÔ∏è</div>

<script>
/* ====== STATE ====== */
const STORAGE_KEY='tdtl_state';
const $=s=>document.querySelector(s);

let state;
try{
  state=JSON.parse(localStorage.getItem(STORAGE_KEY))||{};
}catch{
  state={};
}
if(!state.players){
  state={
    players:[],
    locked:false,
    showCols:false,
    sortAsc:true
  };
}

/* ====== HELPERS ====== */
function save(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
}
function toast(m){
  const t=$('#toast');
  t.textContent=m;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1200);
}
function rowClass(p){
  // applique la couleur de fond en fonction de pr√©sence+montant
  if(!p.present) return '';
  if(p.montant==null || p.montant==='') return 'row-yellow';
  const m=Number(p.montant);
  if(isNaN(m)) return 'row-yellow';
  if(m===0) return 'row-red';
  return 'row-green';
}
function updatePresenceRate(){
  const total=state.players.length;
  const presents=state.players.filter(p=>p.present).length;
  const pct=total ? Math.round((presents/total)*100) : 0;
  $('#countPresence').textContent=pct+'%';
}

/* ====== RENDER TABLE ====== */
function render(){
  const tb=$('#tbody');
  tb.textContent='';

  // message "Aucun joueur"
  $('#empty').style.display = state.players.length ? 'none' : 'block';

  let cnt={green:0,yellow:0,red:0};
  let total=0;

  state.players.forEach(p=>{
    const tr=document.createElement('tr');

    // ligne color√©e selon rules
    const rc=rowClass(p);
    if(rc) tr.classList.add(rc);

    // compteurs ronds
    if(rc==='row-green') cnt.green++;
    else if(rc==='row-yellow') cnt.yellow++;
    else if(rc==='row-red') cnt.red++;

    // total ‚Ç¨
    if(p.present && Number(p.montant)>0){
      total+=Number(p.montant);
    }

    tr.innerHTML=`
      <td>${(p.nom||'').toUpperCase()} ${(p.prenom||'')}</td>
      <td class="td-tel">${p.tel||'‚Äî'}</td>
      <td class="td-mail">${p.mail||'‚Äî'}</td>
      <td style="text-align:center">
        <input type="checkbox" ${p.present?'checked':''} ${state.locked?'disabled':''}>
      </td>
      <td>
        <input type="number" value="${p.montant??''}" style="width:86px" ${state.locked?'disabled':''}>
      </td>
      <td>
        <button class="btn" title="√âditer">‚úé</button>
        <button class="btn blueLight" title="Supprimer">üóë</button>
      </td>
    `;

    // masquer Tel / Mail si demand√©
    if(!state.showCols){
      tr.querySelector('.td-tel').classList.add('hiddenCol');
      tr.querySelector('.td-mail').classList.add('hiddenCol');
    }

    // brancher les contr√¥les ligne
    const cb=tr.querySelector('input[type=checkbox]');
    const money=tr.querySelector('input[type=number]');
    const [editBtn,delBtn]=tr.querySelectorAll('button');

    cb.onchange=()=>{
      p.present=cb.checked;
      save();
      render();
    };

    money.oninput=()=>{
      const rawVal=money.value;
      p.montant=(rawVal==='')?null:Number(rawVal);
      save();
      render();
    };

    editBtn.onclick=()=>{
      if(state.locked)return;
      const n   =prompt('Nom ?',p.nom||'');   if(n===null)return;
      const pr  =prompt('Pr√©nom ?',p.prenom||''); if(pr===null)return;
      const tel =prompt('T√©l√©phone ?',p.tel||''); if(tel===null)return;
      const mail=prompt('E-mail ?',p.mail||'');   if(mail===null)return;

      p.nom=n.trim();
      p.prenom=pr.trim();
      p.tel=tel.trim();
      p.mail=mail.trim();
      save();
      render();
      toast('Modifi√©');
    };

    delBtn.onclick=()=>{
      if(state.locked)return;
      if(confirm('Supprimer cette ligne ?')){
        state.players=state.players.filter(x=>x!==p);
        save();
        render();
        toast('Supprim√©');
      }
    };

    tb.appendChild(tr);
  });

  // stats haut de page
  $('#statInscrits').textContent  = state.players.length;
  $('#statPresents').textContent  = state.players.filter(p=>p.present).length;
  $('#statTotal').textContent     = total.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨';

  // compteurs pastilles
  $('#countGreen').textContent  = cnt.green;
  $('#countYellow').textContent = cnt.yellow;
  $('#countRed').textContent    = cnt.red;

  // % pr√©sents
  updatePresenceRate();

  // masque les <th> Tel / Mail si besoin
  document.querySelectorAll('thead .th-tel, thead .th-mail').forEach(th=>{
    th.classList.toggle('hiddenCol', !state.showCols);
  });
}

/* ====== AJOUT JOUEUR ====== */
$('#addForm').onsubmit=e=>{
  e.preventDefault();
  if(state.locked){toast('üîí');return;}

  const prenom=$('#prenom').value.trim();
  const nom=$('#nom').value.trim();
  const tel=$('#tel').value.trim();
  const mail=$('#mail').value.trim();

  if(!prenom||!nom){
    alert('Nom et pr√©nom requis');
    return;
  }

  state.players.push({
    prenom,
    nom,
    tel,
    mail,
    present:false,
    montant:null
  });

  save();
  render();
  e.target.reset();
  toast('Ajout√©');
};

/* ====== VERROUILLAGE (üîí rouge / üîì vert) ====== */
function updateLockButton(){
  const b=$('#btnLock');
  if(state.locked){
    b.textContent='üîí';
    b.className='btn locked';
  }else{
    b.textContent='üîì';
    b.className='btn unlocked';
  }
}
$('#btnLock').onclick=()=>{
  state.locked=!state.locked;
  save();
  render();
  updateLockButton();
};
updateLockButton();

/* ====== EFFACER PR√âSENT + MONTANTS ====== */
$('#btnClearData').onclick=()=>{
  if(state.locked){toast('üîí');return;}
  if(!confirm('Effacer Pr√©sent + Montants ?'))return;
  state.players.forEach(p=>{
    p.present=false;
    p.montant=null;
  });
  save();
  render();
  toast('Donn√©es effac√©es');
};

/* ====== OPTIONS SHEET ====== */
const sheet=$('#sheetOptions');
$('#btnOptions').onclick=()=>{
  sheet.classList.add('show');
  sheet.setAttribute('aria-hidden','false');
};
$('#btnCloseOptions').onclick=()=>{
  sheet.classList.remove('show');
  sheet.setAttribute('aria-hidden','true');
};

/* masquer / afficher Tel & Mail */
$('#btnToggleCols').onclick=()=>{
  state.showCols=!state.showCols;
  save();
  render();
  toast(state.showCols?'Colonnes affich√©es':'Colonnes masqu√©es');
};

/* supprimer TOUTE la liste */
$('#btnDeleteAll').onclick=()=>{
  if(state.locked){toast('üîí');return;}
  if(!state.players.length){toast('Liste vide');return;}
  if(confirm('Supprimer TOUTE la liste ?')){
    state.players=[];
    save();
    render();
    toast('Liste supprim√©e');
  }
};

/* ====== IMPORT CSV ======
   Format attendu :
   prenom;nom;tel;mail;present;montant
   - s√©parateur ; ou ,
   - present: 1 / true / oui / o / x
   - montant: nombre (virgule ok)
*/
$('#btnImport').onclick=()=>{
  if(state.locked){toast('üîí');return;}

  const input=document.createElement('input');
  input.type='file';
  input.accept='.csv,text/csv';

  input.onchange=async e=>{
    const f=e.target.files[0];
    if(!f)return;

    // lire texte brut du CSV
    const txt=await f.text();

    // lignes non vides
    const lines=txt
      .split(/\r?\n/)
      .map(l=>l.trim())
      .filter(l=>l!=='');

    if(lines.length<2){
      alert('Fichier vide');
      return;
    }

    // d√©tecter le s√©parateur
    const sep = lines[0].includes(';') ? ';' : ',';

    // headers
    const headers=lines[0].split(sep).map(h=>h.trim().toLowerCase());

    const idx={
      prenom:  headers.indexOf('prenom'),
      nom:     headers.indexOf('nom'),
      tel:     headers.indexOf('tel'),
      mail:    headers.indexOf('mail'),
      present: headers.indexOf('present'),
      montant: headers.indexOf('montant')
    };

    // on veut au moins prenom et nom
    if(idx.prenom<0 || idx.nom<0){
      alert('Ent√™tes requis : prenom;nom;tel;mail;present;montant');
      return;
    }

    const imported=[];

    for(let i=1;i<lines.length;i++){
      const cols=lines[i].split(sep);

      const prenom=(cols[idx.prenom]||'').trim();
      const nom   =(cols[idx.nom]   ||'').trim();
      const tel   = idx.tel>=0  ? (cols[idx.tel]  ||'').trim() : '';
      const mail  = idx.mail>=0 ? (cols[idx.mail] ||'').trim() : '';

      // ignore ligne totalement vide
      if(!prenom && !nom) continue;

      // pr√©sent
      let present=false;
      if(idx.present>=0){
        const rawPres=(cols[idx.present]||'').trim();
        if(/^(1|true|oui|o|x)$/i.test(rawPres)){
          present=true;
        }
      }

      // montant
      let montant=null;
      if(idx.montant>=0){
        const rawM=(cols[idx.montant]||'').trim();
        if(rawM!==''){
          const n=Number(rawM.replace(',','.'));
          if(!isNaN(n)){
            montant=n;
          }
        }
      }

      imported.push({
        prenom,
        nom,
        tel,
        mail,
        present,
        montant
      });
    }

    if(!imported.length){
      alert('Aucune ligne valide');
      return;
    }

    if(!confirm(`Importer ${imported.length} lignes ?`))return;

    state.players=imported;
    save();
    render();
    toast('Import√©');
  };

  input.click();
};

/* ====== TRI PAR NOM & PR√âNOM ====== */
$('#thName').onclick=()=>{
  state.sortAsc=!state.sortAsc;
  state.players.sort((a,b)=>{
    const an=((a.nom||'')+' '+(a.prenom||'')).toLowerCase();
    const bn=((b.nom||'')+' '+(b.prenom||'')).toLowerCase();
    return state.sortAsc ? an.localeCompare(bn) : bn.localeCompare(an);
  });
  save();
  render();
  toast(state.sortAsc?'Tri A‚ÜíZ':'Tri Z‚ÜíA');
};

/* ====== INIT ====== */
render();
</script>
</body>
</html>